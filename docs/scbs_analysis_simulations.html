<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Sun, Adam" />

<meta name="date" content="2020-03-16" />

<title>SCB Analysis on Simulated TS</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">SCBs_Exploration</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/acloudysun12/SCBs_Exploration">
    <span class="fa fa-github"></span>
     
    Source code
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">SCB Analysis on Simulated TS</h1>
<h4 class="author"><em>Sun, Adam</em></h4>
<h4 class="date"><em>March 16, 2020</em></h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span> workflowr <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> </a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2020-04-15
</p>
<p>
<strong>Checks:</strong> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 7 <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> 0
</p>
<p>
<strong>Knit directory:</strong> <code>SCBs_Exploration/</code> <span class="glyphicon glyphicon-question-sign" aria-hidden="true" title="This is the local directory in which the code in this file was executed."> </span>
</p>
<p>
This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a> analysis was created with <a
  href="https://github.com/jdblischak/workflowr">workflowr</a> (version 1.4.0). The <em>Checks</em> tab describes the reproducibility checks that were applied when the results were created. The <em>Past versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>R Markdown file:</strong> up-to-date </a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate" class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git repository, you know the exact version of the code that produced these results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20200222code"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Seed:</strong> <code>set.seed(20200222)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20200222code" class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20200222)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Session information:</strong> recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be confident that you successfully produced the results during this run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomacloudysun12SCBsExplorationtree69f8b36de05d8ccfa3ca5d4b6cdc6eadeb1ebb8ctargetblank69f8b36a"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Repository version:</strong> <a href="https://github.com/acloudysun12/SCBs_Exploration/tree/69f8b36de05d8ccfa3ca5d4b6cdc6eadeb1ebb8c" target="_blank">69f8b36</a> </a>
</p>
</div>
<div id="strongRepositoryversionstrongahrefhttpsgithubcomacloudysun12SCBsExplorationtree69f8b36de05d8ccfa3ca5d4b6cdc6eadeb1ebb8ctargetblank69f8b36a" class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility. The version displayed above was the version of the Git repository at the time these results were generated. <br><br> Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .Rhistory

Unstaged changes:
    Modified:   analysis/weather_data_analysis.Rmd

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the R Markdown and HTML files. If you’ve configured a remote Git repository (see <code>?wflow_git_remote</code>), click on the hyperlinks in the table below to view them.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/acloudysun12/SCBs_Exploration/blob/69f8b36de05d8ccfa3ca5d4b6cdc6eadeb1ebb8c/analysis/scbs_analysis_simulations.Rmd" target="_blank">69f8b36</a>
</td>
<td>
Adam Sun
</td>
<td>
2020-04-15
</td>
<td>
simulation analysis
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="scb-prep-functions" class="section level2">
<h2>SCB Prep Functions <br></h2>
<pre class="r"><code>calc_sig_hats_eq25 = function(series, p = 1/3){
  k_n = round(length(series)^p)
  breaks = c(seq(1, length(series), by = k_n))
  m = floor(length(series)/k_n)
  A_ms = cbind(idx = seq(1,length(series)), series) %&gt;% as.data.frame() %&gt;% 
    mutate(m = cut(idx, breaks = breaks, labels = FALSE, include.lowest = TRUE)) %&gt;% 
    filter(!is.na(m)) %&gt;% # we do not want remainders since not enough for one more interval
    group_by(m) %&gt;% summarize(A_m = mean(series)) %&gt;% select(A_m) %&gt;% as.matrix()
  
  q3_norm = qnorm(p = 0.75, 0, 1)
  sig_hat_1 = sqrt(pi*k_n)/(2*(m-1))*sum(abs(A_ms - lag(A_ms, 1)), na.rm = TRUE)
  sig_hat_2 = sqrt(k_n/(2*q3_norm))*median(abs(A_ms - lag(A_ms, 1)), na.rm = TRUE)
  sig_hat_3 = sqrt(k_n/(2*(length(breaks)-1)))*sum((A_ms - lag(A_ms, 1))^2, na.rm = TRUE)^(1/2)
  
  return(list(k_n = k_n, A_ms = A_ms, hat_1 = sig_hat_1, hat_2 = sig_hat_2, hat_3 = sig_hat_3))
  
}

calc_k_final = function(time_idx, series, sig_hat){
  k_ruppert = dpill(x = time_idx, y = series)
  b_ruppert = k_ruppert/length(series)
  loclin_1 = locpoly(time_idx, series, bandwidth = k_ruppert, gridsize = length(time_idx))
  loclin_2 = locpoly(time_idx, series, bandwidth = k_ruppert*sqrt(2), gridsize = length(time_idx))
  e_hats = series - (2*loclin_1$y - loclin_2$y) 
  nu = sum(e_hats^2)/length(series)
  rho_hat = sig_hat^2/nu
  k_final = 2*(rho_hat)^(1/5)*k_ruppert
  return(list(k_final = k_final, e_hats = e_hats, nu = nu, rho_hat = rho_hat)) 
}


calc_suprem_rnorm = function(rand_iter, time_idx, k_final){
  loclin_iter_b_1 = locpoly(x = time_idx, y = rand_iter, bandwidth = k_final, gridsize = length(time_idx))
  loclin_iter_b_2 = locpoly(x = time_idx, y = rand_iter, bandwidth = k_final*sqrt(2), gridsize = length(time_idx))
  return(mu_suprem = max(abs(2*loclin_iter_b_1$y - loclin_iter_b_2$y))) 
}

calc_q95 = function(sup_mus_boot){
  return(quantile(abs(sup_mus_boot), 0.95))
} 

calc_coverage = function(time_idx, series, mean_series, q_95, sig_hat, k_final){
  interval_95 = q_95*sig_hat 
  loclin_1 = locpoly(x = time_idx, y = series, bandwidth = k_final, gridsize = length(time_idx))
  loclin_2 = locpoly(x = time_idx, y = series, bandwidth = k_final*sqrt(2), gridsize = length(time_idx))
  series_tilde = 2*loclin_1$y - loclin_2$y
  return(sum(abs(mean_series - series_tilde) &gt; interval_95))
}

calc_mu_tilde = function(time_idx, series, k_final){
  loclin_1 = locpoly(x = time_idx, y = series, bandwidth = k_final, gridsize = length(time_idx))
  loclin_2 = locpoly(x = time_idx, y = series, bandwidth = k_final*sqrt(2), gridsize = length(time_idx))
  series_tilde = 2*loclin_1$y - loclin_2$y
  return(series_tilde)
}

calc_SCBs = function(time_idx, series, sup_mus_boot, q_95, sig_hat, k_final){
  interval_95 = q_95*sig_hat 
  series_tilde = calc_mu_tilde(time_idx = time_idx, series = series, k_final = k_final)
  temps_UB = series_tilde + interval_95
  temps_LB = series_tilde - interval_95
  return(list(q_95 = interval_95, loclin_fit = series_tilde, series_UB = temps_UB, series_LB = temps_LB))
}</code></pre>
<p><br></p>
</div>
<div id="simulations" class="section level2">
<h2>Simulations <br></h2>
<div id="test-the-coverage-and-bias-first-with-an-ar1-series." class="section level3">
<h3>Test the coverage and bias first with an AR1 series.</h3>
<p>This is for a proof of concept. <br> The SCBs should be close to the nominal 95% coverage (i.e. optimal) under the assumption that the error terms follow a stationary process. <br> We let our error term be an AR1 series, with <span class="math inline">\(\phi_1 = 0.5\)</span>. Thus, our model is <span class="math inline">\(e_n = 0.5e_{n-1} + \epsilon_n\)</span>. <br> The variance of our AR1 model is <span class="math inline">\(\frac{1}{1-.5^2} = \frac{4}{3}\)</span>. This is because <span class="math inline">\(Var(e_n)\)</span> can be re-written as <span class="math inline">\(E(.5e_{n-1} + \epsilon_n, .5e_{n-1} + \epsilon_n) = .5^2Var(e_{n-1}) + 1\)</span>, since <span class="math inline">\(\epsilon_i&#39;s \sim i.i.d. N(0,1)\)</span>. <br> <span class="math inline">\(e_n\)</span> being stationary implies we can re-write the equation as <span class="math inline">\(\hat\gamma_0(1-.5^2) = 1 \rightarrow \hat\gamma_0 = \frac{1}{.75}\)</span>. <br></p>
<p>For an AR1 model with finite length, we estimate the long-term variance with a length 10^6 AR1 series. <br> To test coverage, we set the underlying mean series <span class="math inline">\(\mu_t = cos(2 \pi t)\)</span> and generate normalized AR1 errors to get 10^4 realizations of <span class="math inline">\(X_n\)</span>. <br> We simulate <span class="math inline">\(t\ in [0,2]\)</span> at intervals of 1/200 (i.e. two full cycles). <br></p>
<p>We follow Section 4 step (b) to adjust the automatic bandwidth selected under Ruppert (i.e. dpill function in R) to the optimal banwidth that would cover the mean series 95% of the time, denoted <span class="math inline">\(b_{opt}\)</span>. <br> To confirm this bandwidth is most representative of the nominal 95% coverage, we calculate coverage rates with bandwidths <span class="math inline">\(\frac{3}{5}b_{opt}\)</span>, <span class="math inline">\(\frac{4}{5}b_{opt}\)</span>, <span class="math inline">\(\frac{5}{4} b_{opt}\)</span>, and <span class="math inline">\(\frac{6}{4} b_{opt}\)</span> as well for comparison,</p>
<pre class="r"><code>set.seed(9999)
sig_hats = numeric()
for (iters in 1:1){
e_is = arima.sim(list(order = c(1,0,0), ar = 0.5), 100000)
sig_hat_LT = round(calc_sig_hats_eq25(e_is, p = 1/3)$hat_3, 3)
sig_hats = c(sig_hats, sig_hat_LT)
}
sig_hat_LT = round(mean(sig_hats), 3)
sig_hat_LT</code></pre>
<pre><code>[1] 1.928</code></pre>
<pre class="r"><code>t = seq(0, 400)
mean_Xn = cos(2*pi*t/200)

vec_k_rups = numeric()
vec_k_opts = numeric()
vec_rho_hats = numeric()
for (iters in 1:1000){
  e_is_iter = arima.sim(list(order = c(1,0,0), ar = 0.5), length(t))
  Xn_sim = cos(2*pi*t/200) + e_is_iter
  k_rup = dpill(x = t, y = Xn_sim)
  k_opt_results = calc_k_final(t, Xn_sim, sig_hat = sig_hat_LT)
  k_opt = k_opt_results$k_final
  vec_k_rups = c(vec_k_rups, k_rup)
  vec_k_opts = c(vec_k_opts, k_opt)
  vec_rho_hats = c(vec_rho_hats, round(k_opt_results$rho_hat, 3))
}

k_rup = round(mean(vec_k_rups), 2)
b_rup = round(k_rup/length(t), 3)
k_opt = round(mean(vec_k_opts), 2)
b_opt = round(k_opt/length(t), 3)
k_lo1 = round(k_opt*0.6, 2)
k_lo2 = round(k_opt*0.8, 2)
k_hi1 = round(k_opt*1.25, 2)
k_hi2 = round(k_opt*1.5, 2)

df_ar1_scbs = data.frame(b = numeric(), q_95 = numeric(), coverage = numeric(), bias = numeric())

q_95_vec = numeric()
num_sims = 10000
for (k_val in c(k_lo1, k_lo2, k_opt, k_hi1, k_hi2)){
  rnorm_sims = matrix(rnorm(num_sims*length(t), 0 ,1), 
                      nrow = num_sims, ncol = length(t))
  sup_mus_boot = apply(rnorm_sims, MARGIN = 1, FUN = calc_suprem_rnorm, 
                       time_idx = t, k_final = k_val)
  q_95 = calc_q95(sup_mus_boot)
  q_95_vec = c(q_95_vec, q_95)
}

# calculate empirical coverages under different optimal bandwidths
for (idx in 1:5){
  k_val = c(k_lo1, k_lo2, k_opt, k_hi1, k_hi2)[idx]
  q_95 = q_95_vec[idx]

  num_reps = 10000
  coverages = numeric(0)
  mu_tildes = vector(&quot;list&quot;, length = num_reps)
  for (iters in 1:num_reps){
    e_is = arima.sim(list(order = c(1,0,0), ar = 0.5), length(t))
    Xn_sim = cos(2*pi*t/200) + e_is
    
    mu_tildes[[iters]] = calc_mu_tilde(time_idx = t, Xn_sim, k_final = k_val)
    coverages = c(coverages, 
                  calc_coverage(t, series = Xn_sim, mean_series = mean_Xn, q_95, sig_hat = sig_hat_LT, k_val))
  }
  
  coverage_pct = length(which(coverages == 0))/length(coverages)
  bias_calc = max(abs(apply(bind_cols(mu_tildes), MARGIN = 1, mean) - mean_Xn))
  
  df_ar1_scbs = rbind(df_ar1_scbs, round(c(k_val/length(t), q_95, coverage_pct, bias_calc), 3))
}

colnames(df_ar1_scbs) = c(&quot;b&quot;, &quot;q_95&quot;, &quot;coverage&quot;, &quot;bias&quot;)</code></pre>
<p><br></p>
<p>Results: Under the automatic bandwidth selector by Ruppert which minimizes MSE for iid errors, the optimal bandwidth is 0.023. The optimal bandwidth adjusted is 0.059. <br> The adjustment uses a variance correction factor of <span class="math inline">\(\hat\rho\)</span> = 3.593 to get <span class="math inline">\(b_{opt}\)</span> = <span class="math inline">\(2\hat\rho^{1/5} \cdot b_{rup}\)</span>. <br> We bootstrap normal errors (with 10^4 repetitions) to estimate the 95% quantile <span class="math inline">\(\hat q_{0.95}\)</span> for each bandwdith. <br> We also use 10^4 repetitions of the series to calculate the bias and empirical coverage rates. <br> The results indicate that our optimal bandwidth generally matches most closely with our nominal 95% coverage. Shorter bandwidths give us higher than 95% coverage, while longer bandwidths give us lower than 95% coverage.</p>
<table>
<thead>
<tr class="header">
<th align="left">b_desc</th>
<th align="right">b</th>
<th align="right">q_95</th>
<th align="right">coverage</th>
<th align="right">bias</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0.60 x b_opt</td>
<td align="right">0.036</td>
<td align="right">0.986</td>
<td align="right">0.966</td>
<td align="right">0.038</td>
</tr>
<tr class="even">
<td align="left">0.80 x b_opt</td>
<td align="right">0.048</td>
<td align="right">0.830</td>
<td align="right">0.957</td>
<td align="right">0.060</td>
</tr>
<tr class="odd">
<td align="left">1.00 x b_opt</td>
<td align="right">0.059</td>
<td align="right">0.743</td>
<td align="right">0.946</td>
<td align="right">0.112</td>
</tr>
<tr class="even">
<td align="left">1.25 x b_opt</td>
<td align="right">0.074</td>
<td align="right">0.666</td>
<td align="right">0.931</td>
<td align="right">0.187</td>
</tr>
<tr class="odd">
<td align="left">1.50 x b_opt</td>
<td align="right">0.089</td>
<td align="right">0.606</td>
<td align="right">0.897</td>
<td align="right">0.313</td>
</tr>
</tbody>
</table>
<p><br></p>
</div>
<div id="calculate-coverage-and-bias-under-non-linear-non-stationary-errors." class="section level3">
<h3>Calculate coverage and bias under non-linear, non-stationary errors.</h3>
<p>We replicate the setup of the error structure in Section 6 to see if we can replicate similar results seen in Table 2. <br> We select a range of values of <span class="math inline">\(\theta \in c(0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9)\)</span> and estimate the long-run standard deviation <span class="math inline">\(\hat\sigma(\theta)\)</span> by generating series with length of 10^4. <br> Our estimated long-run standard deviations tie out with Table 1. <br> We note that the 1st and 3rd methods of calculating <span class="math inline">\(\sigma_1\)</span> and <span class="math inline">\(\sigma_3\)</span> are similar, while <span class="math inline">\(\sigma_2\)</span> is considerably smaller. As suggested by the paper and its calculation, <span class="math inline">\(\sigma_2\)</span> is more robust to jumps in the mean series (since it relies on calculating the median), but when jumps are not present in the series as is the case with <span class="math inline">\(X_n = cos(2\pi n)\)</span>, <span class="math inline">\(\sigma_1\)</span> and <span class="math inline">\(\sigma_3\)</span> are more accurate.</p>
<p>Table of estimated long-run SDs <span class="math inline">\(\hat\sigma(\theta)\)</span>:</p>
<table>
<caption>Table of estimated long-run SDs:</caption>
<thead>
<tr class="header">
<th align="left">sigma</th>
<th align="right">0</th>
<th align="right">0.1</th>
<th align="right">0.2</th>
<th align="right">0.3</th>
<th align="right">0.4</th>
<th align="right">0.5</th>
<th align="right">0.6</th>
<th align="right">0.7</th>
<th align="right">0.8</th>
<th align="right">0.9</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">hat_1</td>
<td align="right">0.990</td>
<td align="right">1.012</td>
<td align="right">1.057</td>
<td align="right">1.026</td>
<td align="right">1.034</td>
<td align="right">1.090</td>
<td align="right">1.194</td>
<td align="right">1.248</td>
<td align="right">1.514</td>
<td align="right">1.807</td>
</tr>
<tr class="even">
<td align="left">hat_2</td>
<td align="right">0.816</td>
<td align="right">0.837</td>
<td align="right">0.870</td>
<td align="right">0.853</td>
<td align="right">0.838</td>
<td align="right">0.914</td>
<td align="right">0.989</td>
<td align="right">1.024</td>
<td align="right">1.240</td>
<td align="right">1.385</td>
</tr>
<tr class="odd">
<td align="left">hat_3</td>
<td align="right">0.994</td>
<td align="right">1.007</td>
<td align="right">1.048</td>
<td align="right">1.016</td>
<td align="right">1.034</td>
<td align="right">1.089</td>
<td align="right">1.184</td>
<td align="right">1.260</td>
<td align="right">1.523</td>
<td align="right">1.863</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>In order to see how non-linearity and bandwidth length affect the coverage, we select range of values for the bandwidth <span class="math inline">\(b_{test} \in c(0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.10, 0.11, 0.12, 0.15, 0.20)\)</span> and use 10^4 repetitions to bootstrap the 95% CI interval <span class="math inline">\(q_95\)</span>. <br> After, we use 10^4 repetitions to bootstrap the <span class="math inline">\(\hat q(b)\)</span> estimate for each bandwidth. <br> Using these <span class="math inline">\(\hat q\)</span>, we generaate 10^4 realizations of the series to calculate the emperical coverage rate. <br> For each <span class="math inline">\(b_{test}\)</span>, we also calculate the bias with 10^4 realizations of the series. Our estimated long-run standard deviations tie out with Table 1. <br></p>
<pre><code>Time difference of 20 mins</code></pre>
<p>Table of coverage rates over bandwidth and <span class="math inline">\(\theta\)</span> grid:</p>
<table>
<caption>Table of coverage rates over bandwidth and theta grid:</caption>
<thead>
<tr class="header">
<th align="right">b</th>
<th align="right">q_95</th>
<th align="right">bias</th>
<th align="right">0</th>
<th align="right">0.1</th>
<th align="right">0.2</th>
<th align="right">0.3</th>
<th align="right">0.4</th>
<th align="right">0.5</th>
<th align="right">0.6</th>
<th align="right">0.7</th>
<th align="right">0.8</th>
<th align="right">0.9</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0.01</td>
<td align="right">2.991</td>
<td align="right">0.053</td>
<td align="right">0.947</td>
<td align="right">0.954</td>
<td align="right">0.963</td>
<td align="right">0.955</td>
<td align="right">0.965</td>
<td align="right">0.976</td>
<td align="right">0.993</td>
<td align="right">0.997</td>
<td align="right">1.000</td>
<td align="right">1.000</td>
</tr>
<tr class="even">
<td align="right">0.02</td>
<td align="right">1.903</td>
<td align="right">0.011</td>
<td align="right">0.957</td>
<td align="right">0.951</td>
<td align="right">0.964</td>
<td align="right">0.952</td>
<td align="right">0.959</td>
<td align="right">0.967</td>
<td align="right">0.981</td>
<td align="right">0.985</td>
<td align="right">0.996</td>
<td align="right">1.000</td>
</tr>
<tr class="odd">
<td align="right">0.03</td>
<td align="right">1.498</td>
<td align="right">0.019</td>
<td align="right">0.948</td>
<td align="right">0.942</td>
<td align="right">0.960</td>
<td align="right">0.944</td>
<td align="right">0.946</td>
<td align="right">0.958</td>
<td align="right">0.973</td>
<td align="right">0.971</td>
<td align="right">0.988</td>
<td align="right">0.998</td>
</tr>
<tr class="even">
<td align="right">0.04</td>
<td align="right">1.302</td>
<td align="right">0.018</td>
<td align="right">0.940</td>
<td align="right">0.946</td>
<td align="right">0.960</td>
<td align="right">0.946</td>
<td align="right">0.951</td>
<td align="right">0.961</td>
<td align="right">0.964</td>
<td align="right">0.968</td>
<td align="right">0.983</td>
<td align="right">0.994</td>
</tr>
<tr class="odd">
<td align="right">0.05</td>
<td align="right">1.163</td>
<td align="right">0.021</td>
<td align="right">0.947</td>
<td align="right">0.953</td>
<td align="right">0.957</td>
<td align="right">0.945</td>
<td align="right">0.951</td>
<td align="right">0.954</td>
<td align="right">0.967</td>
<td align="right">0.966</td>
<td align="right">0.979</td>
<td align="right">0.987</td>
</tr>
<tr class="even">
<td align="right">0.06</td>
<td align="right">1.047</td>
<td align="right">0.032</td>
<td align="right">0.941</td>
<td align="right">0.945</td>
<td align="right">0.961</td>
<td align="right">0.942</td>
<td align="right">0.944</td>
<td align="right">0.949</td>
<td align="right">0.962</td>
<td align="right">0.957</td>
<td align="right">0.973</td>
<td align="right">0.980</td>
</tr>
<tr class="odd">
<td align="right">0.07</td>
<td align="right">0.977</td>
<td align="right">0.046</td>
<td align="right">0.950</td>
<td align="right">0.948</td>
<td align="right">0.960</td>
<td align="right">0.948</td>
<td align="right">0.947</td>
<td align="right">0.947</td>
<td align="right">0.965</td>
<td align="right">0.957</td>
<td align="right">0.967</td>
<td align="right">0.973</td>
</tr>
<tr class="even">
<td align="right">0.08</td>
<td align="right">0.911</td>
<td align="right">0.046</td>
<td align="right">0.948</td>
<td align="right">0.947</td>
<td align="right">0.957</td>
<td align="right">0.946</td>
<td align="right">0.946</td>
<td align="right">0.950</td>
<td align="right">0.957</td>
<td align="right">0.955</td>
<td align="right">0.965</td>
<td align="right">0.976</td>
</tr>
<tr class="odd">
<td align="right">0.10</td>
<td align="right">0.821</td>
<td align="right">0.062</td>
<td align="right">0.948</td>
<td align="right">0.948</td>
<td align="right">0.957</td>
<td align="right">0.947</td>
<td align="right">0.943</td>
<td align="right">0.947</td>
<td align="right">0.953</td>
<td align="right">0.950</td>
<td align="right">0.960</td>
<td align="right">0.959</td>
</tr>
<tr class="even">
<td align="right">0.12</td>
<td align="right">0.738</td>
<td align="right">0.108</td>
<td align="right">0.927</td>
<td align="right">0.933</td>
<td align="right">0.941</td>
<td align="right">0.931</td>
<td align="right">0.921</td>
<td align="right">0.931</td>
<td align="right">0.940</td>
<td align="right">0.927</td>
<td align="right">0.944</td>
<td align="right">0.928</td>
</tr>
<tr class="odd">
<td align="right">0.15</td>
<td align="right">0.664</td>
<td align="right">0.205</td>
<td align="right">0.886</td>
<td align="right">0.882</td>
<td align="right">0.894</td>
<td align="right">0.879</td>
<td align="right">0.873</td>
<td align="right">0.887</td>
<td align="right">0.885</td>
<td align="right">0.873</td>
<td align="right">0.900</td>
<td align="right">0.878</td>
</tr>
<tr class="even">
<td align="right">0.20</td>
<td align="right">0.575</td>
<td align="right">0.375</td>
<td align="right">0.621</td>
<td align="right">0.635</td>
<td align="right">0.652</td>
<td align="right">0.635</td>
<td align="right">0.626</td>
<td align="right">0.647</td>
<td align="right">0.665</td>
<td align="right">0.653</td>
<td align="right">0.679</td>
<td align="right">0.677</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>Results: <br> Our results tie out closely with Table 2 of Wu’s paper. <br> Under the automatic bandwidth selector by Ruppert which minimizes MSE for iid errors, the optimal bandwidth is 0.065. The optimal bandwidth adjusted is 0.065. Under this bandwidth, the empirical coverage rates range from 0.949 to 0.955 for <span class="math inline">\(\theta\)</span> up to 0.5, indicating that the empirical coveraage is well-maintained. <br> However, as <span class="math inline">\(\theta\)</span> increase, we would need to select larger bandwidths for ensure a valid 95% approximation, as indicated by the columns for <span class="math inline">\(\theta =\)</span> 0.8 or 0.9 where the 95% nominal coverage is not achieved until b = 0.10. <br> However, larger bandwidthss do come at the cost of higher bias, which consequently decreases the empirical coverage rate. This is observed by looking at the range of coverage rates across <span class="math inline">\(\theta\)</span> for b &gt; 0.15 – the empirical coverage rate drops off steeply to less than 70%, with bias increasing to almost 0.4, which represent 20% of the range of values the mean cosine series can take. <br></p>
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.5.1 (2018-07-02)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 18362)

Matrix products: default

locale:
[1] LC_COLLATE=English_United States.1252 
[2] LC_CTYPE=English_United States.1252   
[3] LC_MONETARY=English_United States.1252
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.1252    

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] KernSmooth_2.23-16 forecast_8.9       fracdiff_1.4-2    
 [4] tseries_0.10-47    scales_1.0.0       forcats_0.3.0     
 [7] stringr_1.4.0      dplyr_0.8.0.1      purrr_0.3.2       
[10] readr_1.1.1        tidyr_0.8.1        tibble_2.1.3      
[13] ggplot2_3.2.1      tidyverse_1.2.1    astsa_1.9         
[16] knitr_1.20        

loaded via a namespace (and not attached):
 [1] zoo_1.8-5         tidyselect_0.2.5  urca_1.3-0       
 [4] haven_1.1.2       lattice_0.20-35   colorspace_1.4-1 
 [7] htmltools_0.3.6   yaml_2.2.0        rlang_0.4.0      
[10] pillar_1.4.2      glue_1.3.1        withr_2.1.2      
[13] TTR_0.23-5        modelr_0.1.2      readxl_1.1.0     
[16] quantmod_0.4-15   timeDate_3043.102 munsell_0.5.0    
[19] gtable_0.3.0      workflowr_1.4.0   cellranger_1.1.0 
[22] rvest_0.3.2       evaluate_0.11     lmtest_0.9-37    
[25] parallel_3.5.1    curl_3.2          highr_0.7        
[28] broom_0.5.0       xts_0.11-2        Rcpp_1.0.2       
[31] backports_1.1.5   jsonlite_1.5      fs_1.2.6         
[34] hms_0.4.2         digest_0.6.21     stringi_1.4.3    
[37] grid_3.5.1        rprojroot_1.3-2   quadprog_1.5-8   
[40] cli_1.1.0         tools_3.5.1       magrittr_1.5     
[43] lazyeval_0.2.2    crayon_1.3.4      whisker_0.3-2    
[46] pkgconfig_2.0.3   xml2_1.2.0        lubridate_1.7.4  
[49] assertthat_0.2.1  rmarkdown_1.10    httr_1.3.1       
[52] rstudioapi_0.8    R6_2.4.0          nnet_7.3-12      
[55] nlme_3.1-137      git2r_0.25.2      compiler_3.5.1   </code></pre>
</div>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
